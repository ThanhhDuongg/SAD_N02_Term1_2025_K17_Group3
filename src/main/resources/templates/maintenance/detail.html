<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết yêu cầu</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="fragments/sidebar :: sidebar"></div>
<div th:replace="~{fragments/header :: popup}"></div>

<div class="content-with-sidebar">
    <div class="container">
        <div class="page-header">
            <div>
                <h2 th:text="'Yêu cầu #' + ${request.id}">Chi tiết yêu cầu</h2>
                <p class="text-muted">Cập nhật trạng thái và xem thông tin liên quan</p>
            </div>
            <a class="button btn-view" th:href="@{/maintenance}">Quay lại danh sách</a>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Thông tin sinh viên</h3>
                <p><strong>Họ tên:</strong> <span th:text="${request.student != null ? request.student.name : 'Không xác định'}"></span></p>
                <p><strong>Mã SV:</strong> <span th:text="${request.student != null ? request.student.code : 'N/A'}"></span></p>
                <p><strong>Email:</strong> <span th:text="${request.student != null ? request.student.email : 'N/A'}"></span></p>
                <p><strong>Số điện thoại:</strong> <span th:text="${request.student != null ? request.student.phone : 'N/A'}"></span></p>
            </div>
            <div class="detail-card">
                <h3>Thông tin phòng</h3>
                <p><strong>Phòng hiện tại:</strong> <span th:text="${request.room != null ? request.room.number : 'N/A'}"></span></p>
                <p><strong>Loại yêu cầu:</strong> <span class="badge" th:text="${#strings.replace(request.requestType, '_', ' ')}"></span></p>
                <p><strong>Phòng mong muốn:</strong> <span th:text="${request.desiredRoomNumber != null ? request.desiredRoomNumber : 'Không có'}"></span></p>
                <p><strong>Ngày gửi:</strong> <span th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
            </div>
        </div>

        <div class="detail-card">
            <h3>Mô tả chi tiết</h3>
            <p th:text="${request.description}"></p>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Thông tin xử lý</h3>
                <p><strong>Trạng thái hiện tại:</strong>
                    <span class="badge"
                          th:classappend="${request.status == 'COMPLETED' ? ' badge-success' :
                                           (request.status == 'IN_PROGRESS' ? ' badge-warning' :
                                           (request.status == 'REJECTED' ? ' badge-danger' : ' badge-info'))}"
                          th:text="${request.status}"></span>
                </p>
                <p><strong>Người phụ trách:</strong>
                    <span th:if="${request.handledBy != null}" th:text="${request.handledBy.username}"></span>
                    <span th:if="${request.handledBy == null}">Chưa phân công</span>
                </p>
                <p><strong>Liên hệ:</strong>
                    <span th:if="${request.handledBy != null}" th:text="${request.handledBy.email}"></span>
                    <span th:if="${request.handledBy == null}">-</span>
                </p>
                <p><strong>Ngày cập nhật:</strong>
                    <span th:text="${request.updatedAt != null ? #temporals.format(request.updatedAt, 'dd/MM/yyyy HH:mm') : #temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
            <div class="detail-card">
                <h3>Ghi chú cho sinh viên</h3>
                <p th:if="${request.resolutionNotes != null}" th:text="${request.resolutionNotes}"></p>
                <p th:if="${request.resolutionNotes == null}" class="text-muted">Chưa có ghi chú xử lý</p>
            </div>
        </div>

        <div class="detail-card">
            <h3>Cập nhật trạng thái</h3>
            <form th:action="@{'/maintenance/' + ${request.id} + '/status'}" method="post" class="status-form">
                <div class="form-group-inline">
                    <label for="status">Trạng thái</label>
                    <select id="status" name="status">
                        <option th:each="status : ${statusOptions}"
                                th:value="${status}"
                                th:selected="${status.equals(request.status)}"
                                th:text="${status}"></option>
                    </select>
                </div>
                <div class="form-group-full">
                    <label for="resolutionNotes">Ghi chú gửi sinh viên</label>
                    <textarea id="resolutionNotes" name="resolutionNotes" rows="3"
                              placeholder="Nhập hướng dẫn hoặc phản hồi cho sinh viên"
                              th:text="${request.resolutionNotes}"></textarea>
                </div>
                <button class="button btn-add" type="submit">Lưu thay đổi</button>
            </form>
        </div>
    </div>
</div>
</body>
</html>
