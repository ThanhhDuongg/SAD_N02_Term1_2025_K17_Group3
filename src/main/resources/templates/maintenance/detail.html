<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết yêu cầu</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div th:replace="fragments/sidebar :: sidebar"></div>
<div th:replace="~{fragments/header :: popup}"></div>

<div class="content-with-sidebar">
    <div class="container">
        <div class="page-header">
            <div>
                <h2 th:text="'Yêu cầu #' + ${request.id}">Chi tiết yêu cầu</h2>
                <p class="text-muted">Cập nhật trạng thái và xem thông tin liên quan</p>
            </div>
            <a class="button btn-view" th:href="@{/maintenance}">Quay lại danh sách</a>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Thông tin sinh viên</h3>
                <p><strong>Họ tên:</strong> <span th:text="${request.student != null ? request.student.name : 'Không xác định'}"></span></p>
                <p><strong>Mã SV:</strong> <span th:text="${request.student != null ? request.student.code : 'N/A'}"></span></p>
                <p><strong>Email:</strong> <span th:text="${request.student != null ? request.student.email : 'N/A'}"></span></p>
                <p><strong>Số điện thoại:</strong> <span th:text="${request.student != null ? request.student.phone : 'N/A'}"></span></p>
            </div>
            <div class="detail-card">
                <h3>Thông tin phòng</h3>
                <p><strong>Phòng hiện tại:</strong> <span th:text="${request.room != null ? request.room.number : 'N/A'}"></span></p>
                <p><strong>Loại yêu cầu:</strong> <span class="badge" th:text="${#strings.replace(request.requestType, '_', ' ')}"></span></p>
                <p><strong>Phòng mong muốn:</strong> <span th:text="${request.desiredRoomNumber != null ? request.desiredRoomNumber : 'Không có'}"></span></p>
                <p><strong>Ngày gửi:</strong> <span th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
            </div>
        </div>

        <div class="detail-card">
            <h3>Mô tả chi tiết</h3>
            <p th:text="${request.description}"></p>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Thông tin xử lý</h3>
                <p><strong>Trạng thái hiện tại:</strong>
                    <span class="badge"
                          th:classappend="${request.status == 'COMPLETED' ? ' badge-success' :
                                           (request.status == 'IN_PROGRESS' ? ' badge-warning' :
                                           (request.status == 'REJECTED' ? ' badge-danger' : ' badge-info'))}"
                          th:text="${request.status}"></span>
                </p>
                <p><strong>Người phụ trách:</strong>
                    <span th:if="${request.handledBy != null}" th:text="${request.handledBy.fullName != null ? request.handledBy.fullName : request.handledBy.username}"></span>
                    <span th:if="${request.handledBy == null}">Chưa phân công</span>
                </p>
                <p><strong>Liên hệ:</strong>
                    <span th:if="${request.handledBy != null}" th:text="${request.handledBy.email}"></span>
                    <span th:if="${request.handledBy == null}">-</span>
                </p>
                <p><strong>Ngày cập nhật:</strong>
                    <span th:text="${request.updatedAt != null ? #temporals.format(request.updatedAt, 'dd/MM/yyyy HH:mm') : #temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
            <div class="detail-card">
                <h3>Ghi chú cho sinh viên</h3>
                <p th:if="${request.resolutionNotes != null}" th:text="${request.resolutionNotes}"></p>
                <p th:if="${request.resolutionNotes == null}" class="text-muted">Chưa có ghi chú xử lý</p>
            </div>
        </div>

        <div class="detail-card">
            <h3>Cập nhật trạng thái</h3>
            <form th:action="@{'/maintenance/' + ${request.id} + '/status'}" method="post" class="status-form">
                <div class="form-group-inline">
                    <label for="status">Trạng thái</label>
                    <select id="status" name="status">
                        <option th:each="status : ${statusOptions}"
                                th:value="${status}"
                                th:selected="${status.equals(request.status)}"
                                th:text="${status}"></option>
                    </select>
                </div>
                <div class="form-group-full">
                    <label for="resolutionNotes">Ghi chú gửi sinh viên</label>
                    <textarea id="resolutionNotes" name="resolutionNotes" rows="3"
                              placeholder="Nhập hướng dẫn hoặc phản hồi cho sinh viên"
                              th:text="${request.resolutionNotes}"></textarea>
                </div>
                <button class="button btn-add" type="submit">Lưu thay đổi</button>
            </form>
        </div>
        <div class="detail-grid">
            <div class="detail-card" sec:authorize="hasRole('ADMIN')">
                <h3>Phân công nhân viên</h3>
                <form th:action="@{'/maintenance/' + ${request.id} + '/assign'}" method="post" class="status-form">
                    <div class="form-group-full">
                        <label for="assigneeId">Chọn nhân viên hỗ trợ</label>
                        <select id="assigneeId" name="assigneeId" required>
                            <option value="">--Chọn nhân viên--</option>
                            <option th:each="staff : ${staffMembers}"
                                    th:value="${staff.id}"
                                    th:text="${staff.fullName != null ? staff.fullName + ' (' + staff.username + ')' : staff.username}"
                                    th:selected="${request.handledBy != null and staff.id.equals(request.handledBy.id)}"></option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button class="button btn-save" type="submit">Phân công</button>
                        <button class="button btn-cancel" type="submit" th:formaction="@{'/maintenance/' + ${request.id} + '/unassign'}"
                                th:disabled="${request.handledBy == null}"
                                onclick="return confirm('Xác nhận hủy phân công yêu cầu này?')">Hủy phân công</button>
                    </div>
                </form>
            </div>
            <div class="detail-card" sec:authorize="hasRole('STAFF')">
                <h3>Tiếp nhận yêu cầu</h3>
                <p th:if="${request.handledBy == null}">Yêu cầu chưa có người xử lý, bạn có thể nhấn nút bên dưới để tiếp nhận.</p>
                <p th:if="${request.handledBy != null}" th:text="${'Đang được xử lý bởi: ' + (request.handledBy.fullName != null ? request.handledBy.fullName : request.handledBy.username)}"></p>
                <div class="form-actions">
                    <form th:if="${request.handledBy == null or request.handledBy.username == #authentication?.name}" th:action="@{'/maintenance/' + ${request.id} + '/accept'}" method="post">
                        <button class="button btn-save" type="submit"
                                th:disabled="${request.handledBy != null and request.handledBy.username == #authentication?.name}">
                            Tôi sẽ xử lý
                        </button>
                    </form>
                    <form th:if="${request.handledBy != null and request.handledBy.username == #authentication?.name}" th:action="@{'/maintenance/' + ${request.id} + '/unassign'}" method="post">
                        <button class="button btn-cancel" type="submit" onclick="return confirm('Bạn chắc chắn muốn hủy tiếp nhận yêu cầu này?')">Hủy tiếp nhận</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
