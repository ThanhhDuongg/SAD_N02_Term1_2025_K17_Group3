<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh Sách Phòng</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="fragments/sidebar :: sidebar"></div>
    <div class="content-with-sidebar">
        <div class="container">
        <h2>Danh Sách Phòng</h2>
        <div th:replace="~{fragments/header :: popup}"></div>
        <div class="search-container room-filter">
            <form th:action="@{/rooms}" method="get">
                <input type="text" name="search" placeholder="Tìm kiếm phòng hoặc loại..." th:value="${search}">
                <select name="buildingId">
                    <option value="" th:selected="${selectedBuildingId == null}">Tất cả tòa</option>
                    <option th:each="building : ${buildings}"
                            th:value="${building.id}"
                            th:text="${building.code + ' - ' + building.name}"
                            th:selected="${selectedBuildingId != null and selectedBuildingId.equals(building.id)}"></option>
                </select>
                <button type="submit">Lọc</button>
            </form>
            <div class="inline-actions">
                <a th:href="@{/rooms/new}" class="button btn-add">Thêm Phòng</a>
                <button type="button" class="button btn-import" id="toggle-auto-create">Thêm phòng tự động</button>
            </div>
        </div>
        <section id="room-auto-panel" class="import-panel" style="display:none;">
            <h3>Thêm phòng tự động</h3>
            <p>Chọn thông tin chung và hệ thống sẽ tạo lần lượt các phòng với mã phòng theo mẫu.</p>
            <form id="auto-create-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="auto-building">Tòa nhà</label>
                        <select id="auto-building" required>
                            <option value="">-- Chọn tòa --</option>
                            <option th:each="building : ${buildings}"
                                    th:value="${building.id}"
                                    th:text="${building.code + ' - ' + building.name}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="auto-floor">Tầng</label>
                        <input type="number" id="auto-floor" min="0" placeholder="Ví dụ: 1">
                    </div>

                    <div class="form-group">
                        <label for="auto-room-type">Loại phòng</label>
                        <select id="auto-room-type" required>
                            <option value="">-- Chọn loại phòng --</option>
                            <option th:each="type : ${roomTypes}"
                                    th:value="${type.id}"
                                    th:text="${type.name}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="auto-capacity">Sức chứa mỗi phòng</label>
                        <input type="number" id="auto-capacity" min="1" placeholder="Ví dụ: 6" required>
                    </div>

                    <div class="form-group">
                        <label for="auto-status">Trạng thái ban đầu</label>
                        <select id="auto-status">
                            <option th:each="status : ${roomStatuses}"
                                    th:value="${status.name()}"
                                    th:text="${status.displayName}"
                                    th:selected="${status.name() == 'AVAILABLE'}"></option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="auto-prefix">Tiền tố mã phòng</label>
                        <input type="text" id="auto-prefix" placeholder="Ví dụ: A1">
                    </div>

                    <div class="form-group">
                        <label for="auto-start">Số bắt đầu</label>
                        <input type="number" id="auto-start" min="0" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="auto-quantity">Số phòng cần tạo</label>
                        <input type="number" id="auto-quantity" min="1" value="1" required>
                    </div>

                    <div class="form-group">
                        <label for="auto-padding">Độ dài số (tự thêm số 0 phía trước)</label>
                        <input type="number" id="auto-padding" min="0" placeholder="Ví dụ: 2">
                    </div>
                </div>
                <p class="help-text">Ví dụ: Tiền tố <strong>A1</strong>, số bắt đầu <strong>1</strong>, độ dài số <strong>2</strong> sẽ tạo ra A101, A102,...</p>
                <div class="import-submit">
                    <button type="submit" id="submit-auto-create">Tạo phòng</button>
                    <button type="button" id="cancel-auto-create" class="button-secondary">Đóng</button>
                </div>
            </form>
            <div id="auto-create-result" class="import-result" aria-live="polite"></div>
        </section>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Số Phòng</th>
                    <th>Tòa</th>
                    <th>Tầng</th>
                    <th>Loại Phòng</th>
                    <th>Sức Chứa</th>
                    <th>Đang Ở</th>
                    <th>Trạng Thái</th>
                    <th>Giá/Tháng</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="room : ${roomsPage.content}" class="table-row">
                    <td th:text="${room.id}"></td>
                    <td th:text="${room.number}"></td>
                    <td th:text="${room.building != null ? room.building.code : 'N/A'}"></td>
                    <td th:text="${room.floor != null ? room.floor : '-'}"></td>
                    <td th:text="${room.roomType != null ? room.roomType.name : room.type}"></td>
                    <td th:text="${room.capacity}"></td>
                    <td th:text="${occupancies[room.id]}"></td>
                    <td th:text="${room.occupancyStatus != null ? room.occupancyStatus.displayName : 'Còn chỗ'}"></td>
                    <td th:text="${room.roomType != null ? T(java.lang.String).format('%,d', room.roomType.currentPrice).replace(',', '.') : T(java.lang.String).format('%,d', room.price).replace(',', '.')}"></td>
                    <td class="action-icons">
                        <a th:href="@{/rooms/{id}(id=${room.id})}" class="view"><i class="fas fa-eye"></i></a>
                        <a th:href="@{/rooms/{id}/edit(id=${room.id})}" class="edit"><i class="fas fa-edit"></i></a>
                        <a th:href="@{/rooms/{id}/delete(id=${room.id})}" class="delete" onclick="return confirm('Bạn có chắc muốn xóa?')"><i class="fas fa-trash"></i></a>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="pagination">
            <a th:if="${roomsPage.number > 0}" th:href="@{/rooms(page=${roomsPage.number-1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}">Trước</a>
            <span th:each="i : ${pageNumbers}">
                <a th:href="@{/rooms(page=${i-1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}"
                   th:text="${i}"
                   th:classappend="${i-1 == roomsPage.number} ? 'current' : ''">
                </a>
            </span>
            <a th:if="${roomsPage.number + 1 < roomsPage.totalPages}" th:href="@{/rooms(page=${roomsPage.number+1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}">Sau</a>
        </div>
        </div>
    </div>
    <script>
        (function() {
            const panel = document.getElementById('room-auto-panel');
            const toggleBtn = document.getElementById('toggle-auto-create');
            const cancelBtn = document.getElementById('cancel-auto-create');
            const form = document.getElementById('auto-create-form');
            const resultBox = document.getElementById('auto-create-result');
            const submitBtn = document.getElementById('submit-auto-create');

            if (!panel || !toggleBtn || !cancelBtn || !form || !resultBox || !submitBtn) {
                return;
            }

            const togglePanel = (show) => {
                panel.style.display = show ? 'block' : 'none';
                if (!show) {
                    form.reset();
                    resultBox.innerHTML = '';
                }
            };

            toggleBtn.addEventListener('click', () => togglePanel(panel.style.display === 'none'));
            cancelBtn.addEventListener('click', () => togglePanel(false));

            const parseInteger = (value) => {
                if (typeof value !== 'string') {
                    return null;
                }
                const trimmed = value.trim();
                if (trimmed === '') {
                    return null;
                }
                const parsed = Number.parseInt(trimmed, 10);
                return Number.isNaN(parsed) ? null : parsed;
            };

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                resultBox.innerHTML = '';

                const payload = {
                    buildingId: parseInteger(document.getElementById('auto-building').value),
                    floor: parseInteger(document.getElementById('auto-floor').value),
                    roomTypeId: parseInteger(document.getElementById('auto-room-type').value),
                    capacity: parseInteger(document.getElementById('auto-capacity').value),
                    occupancyStatus: document.getElementById('auto-status').value || null,
                    prefix: document.getElementById('auto-prefix').value || '',
                    startNumber: parseInteger(document.getElementById('auto-start').value),
                    quantity: parseInteger(document.getElementById('auto-quantity').value),
                    padding: parseInteger(document.getElementById('auto-padding').value)
                };

                if (!payload.buildingId) {
                    alert('Vui lòng chọn tòa nhà.');
                    return;
                }
                if (!payload.roomTypeId) {
                    alert('Vui lòng chọn loại phòng.');
                    return;
                }
                if (!payload.capacity || payload.capacity <= 0) {
                    alert('Sức chứa phải lớn hơn 0.');
                    return;
                }
                if (!payload.quantity || payload.quantity <= 0) {
                    alert('Số phòng cần tạo phải lớn hơn 0.');
                    return;
                }
                if (payload.startNumber === null) {
                    alert('Vui lòng nhập số bắt đầu.');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Đang tạo...';

                try {
                    const response = await fetch('/rooms/auto-create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('Máy chủ trả về mã lỗi ' + response.status);
                    }

                    const result = await response.json();
                    const { createdCount, errors } = result;
                    const summary = document.createElement('p');
                    summary.textContent = `Đã tạo ${createdCount} phòng mới.`;
                    resultBox.appendChild(summary);

                    if (errors && errors.length) {
                        const errorHeading = document.createElement('p');
                        errorHeading.textContent = 'Có phòng không thể tạo:';
                        resultBox.appendChild(errorHeading);

                        const errorList = document.createElement('ul');
                        errors.forEach((err) => {
                            const item = document.createElement('li');
                            item.textContent = err;
                            errorList.appendChild(item);
                        });
                        resultBox.appendChild(errorList);
                    } else if (createdCount > 0) {
                        const successMsg = document.createElement('p');
                        successMsg.textContent = 'Tạo phòng thành công! Làm mới trang để xem dữ liệu mới.';
                        resultBox.appendChild(successMsg);
                    }
                } catch (error) {
                    const failure = document.createElement('p');
                    failure.textContent = 'Không thể tạo phòng tự động: ' + error.message;
                    resultBox.appendChild(failure);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Tạo phòng';
                }
            });
        })();
    </script>
</body>
</html>
