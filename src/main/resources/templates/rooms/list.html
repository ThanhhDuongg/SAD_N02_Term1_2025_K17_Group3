<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh Sách Phòng</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="fragments/sidebar :: sidebar"></div>
    <div class="content-with-sidebar">
        <div class="container">
        <h2>Danh Sách Phòng</h2>
        <div th:replace="~{fragments/header :: popup}"></div>
        <div class="search-container room-filter">
            <form th:action="@{/rooms}" method="get">
                <input type="text" name="search" placeholder="Tìm kiếm phòng hoặc loại..." th:value="${search}">
                <select name="buildingId">
                    <option value="" th:selected="${selectedBuildingId == null}">Tất cả tòa</option>
                    <option th:each="building : ${buildings}"
                            th:value="${building.id}"
                            th:text="${building.code + ' - ' + building.name}"
                            th:selected="${selectedBuildingId != null and selectedBuildingId.equals(building.id)}"></option>
                </select>
                <button type="submit">Lọc</button>
            </form>
            <div class="inline-actions">
                <a th:href="@{/rooms/new}" class="button btn-add">Thêm Phòng</a>
                <button type="button" class="button btn-import" id="toggle-import">Import Phòng</button>
            </div>
        </div>
        <section id="room-import-panel" class="import-panel" style="display:none;">
            <h3>Import Phòng Hàng Loạt</h3>
            <p>Sử dụng JSON array để import nhiều phòng cùng lúc. Mỗi phòng cần các thông tin:</p>
            <ul>
                <li><strong>number</strong>: Mã phòng/số phòng (bắt buộc, duy nhất).</li>
                <li><strong>buildingId</strong>: ID tòa nhà (bắt buộc).</li>
                <li><strong>floor</strong>: Tầng (tùy chọn).</li>
                <li><strong>capacity</strong>: Sức chứa (bắt buộc &gt; 0).</li>
                <li><strong>occupancyStatus</strong>: Trạng thái (AVAILABLE hoặc FULL).</li>
                <li><strong>roomTypeId</strong>: ID loại phòng liên kết (bắt buộc).</li>
            </ul>
            <p>Ví dụ:</p>
            <pre class="import-example">[
  {
    "number": "A101",
    "buildingId": 1,
    "floor": 1,
    "capacity": 6,
    "occupancyStatus": "AVAILABLE",
    "roomTypeId": 2
  },
  {
    "number": "A102",
    "buildingId": 1,
    "floor": 1,
    "capacity": 6,
    "occupancyStatus": "AVAILABLE",
    "roomTypeId": 2
  }
]</pre>
            <div class="import-actions">
                <label for="import-file">Chọn file JSON</label>
                <input type="file" id="import-file" accept="application/json,.json">
                <button type="button" id="load-import-file">Nạp từ file</button>
            </div>
            <textarea id="import-json" rows="10" placeholder="Dán dữ liệu JSON tại đây..."></textarea>
            <div class="import-submit">
                <button type="button" id="submit-import">Thực hiện Import</button>
                <button type="button" id="cancel-import" class="button-secondary">Đóng</button>
            </div>
            <div id="import-result" class="import-result" aria-live="polite"></div>
        </section>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Số Phòng</th>
                    <th>Tòa</th>
                    <th>Tầng</th>
                    <th>Loại Phòng</th>
                    <th>Sức Chứa</th>
                    <th>Đang Ở</th>
                    <th>Trạng Thái</th>
                    <th>Giá/Tháng</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="room : ${roomsPage.content}" class="table-row">
                    <td th:text="${room.id}"></td>
                    <td th:text="${room.number}"></td>
                    <td th:text="${room.building != null ? room.building.code : 'N/A'}"></td>
                    <td th:text="${room.floor != null ? room.floor : '-'}"></td>
                    <td th:text="${room.roomType != null ? room.roomType.name : room.type}"></td>
                    <td th:text="${room.capacity}"></td>
                    <td th:text="${occupancies[room.id]}"></td>
                    <td th:text="${room.occupancyStatus != null ? room.occupancyStatus.displayName : 'Còn chỗ'}"></td>
                    <td th:text="${room.roomType != null ? T(java.lang.String).format('%,d', room.roomType.currentPrice).replace(',', '.') : T(java.lang.String).format('%,d', room.price).replace(',', '.')}"></td>
                    <td class="action-icons">
                        <a th:href="@{/rooms/{id}(id=${room.id})}" class="view"><i class="fas fa-eye"></i></a>
                        <a th:href="@{/rooms/{id}/edit(id=${room.id})}" class="edit"><i class="fas fa-edit"></i></a>
                        <a th:href="@{/rooms/{id}/delete(id=${room.id})}" class="delete" onclick="return confirm('Bạn có chắc muốn xóa?')"><i class="fas fa-trash"></i></a>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="pagination">
            <a th:if="${roomsPage.number > 0}" th:href="@{/rooms(page=${roomsPage.number-1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}">Trước</a>
            <span th:each="i : ${pageNumbers}">
                <a th:href="@{/rooms(page=${i-1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}"
                   th:text="${i}"
                   th:classappend="${i-1 == roomsPage.number} ? 'current' : ''">
                </a>
            </span>
            <a th:if="${roomsPage.number + 1 < roomsPage.totalPages}" th:href="@{/rooms(page=${roomsPage.number+1},size=${roomsPage.size},search=${search},buildingId=${selectedBuildingId})}">Sau</a>
        </div>
        </div>
    </div>
    <script>
        (function() {
            const panel = document.getElementById('room-import-panel');
            const toggleBtn = document.getElementById('toggle-import');
            const cancelBtn = document.getElementById('cancel-import');
            const submitBtn = document.getElementById('submit-import');
            const fileInput = document.getElementById('import-file');
            const loadFileBtn = document.getElementById('load-import-file');
            const jsonInput = document.getElementById('import-json');
            const resultBox = document.getElementById('import-result');

            if (!panel || !toggleBtn || !cancelBtn || !submitBtn || !loadFileBtn || !fileInput || !jsonInput || !resultBox) {
                return;
            }

            const togglePanel = (show) => {
                panel.style.display = show ? 'block' : 'none';
                if (!show) {
                    jsonInput.value = '';
                    fileInput.value = '';
                    resultBox.innerHTML = '';
                }
            };

            toggleBtn.addEventListener('click', () => togglePanel(panel.style.display === 'none'));
            cancelBtn.addEventListener('click', () => togglePanel(false));

            loadFileBtn.addEventListener('click', () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    alert('Vui lòng chọn file JSON trước.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    jsonInput.value = event.target.result;
                };
                reader.onerror = () => alert('Không thể đọc file, vui lòng thử lại.');
                reader.readAsText(file, 'UTF-8');
            });

            submitBtn.addEventListener('click', async () => {
                let payload;
                try {
                    payload = JSON.parse(jsonInput.value);
                    if (!Array.isArray(payload)) {
                        throw new Error('Dữ liệu phải là một mảng JSON.');
                    }
                } catch (error) {
                    alert('Dữ liệu JSON không hợp lệ: ' + error.message);
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Đang import...';
                resultBox.innerHTML = '';

                try {
                    const response = await fetch('/rooms/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('Máy chủ trả về mã lỗi ' + response.status);
                    }

                    const result = await response.json();
                    const { createdCount, errors } = result;
                    const summary = document.createElement('p');
                    summary.textContent = `Đã tạo ${createdCount} phòng mới.`;
                    resultBox.appendChild(summary);

                    if (errors && errors.length) {
                        const errorList = document.createElement('ul');
                        errors.forEach((err) => {
                            const item = document.createElement('li');
                            item.textContent = err;
                            errorList.appendChild(item);
                        });
                        const heading = document.createElement('p');
                        heading.textContent = 'Có lỗi xảy ra:';
                        resultBox.appendChild(heading);
                        resultBox.appendChild(errorList);
                    } else {
                        const successMsg = document.createElement('p');
                        successMsg.textContent = 'Import thành công! Làm mới trang để xem dữ liệu mới.';
                        resultBox.appendChild(successMsg);
                    }
                } catch (error) {
                    const failure = document.createElement('p');
                    failure.textContent = 'Import thất bại: ' + error.message;
                    resultBox.appendChild(failure);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Thực hiện Import';
                }
            });
        })();
    </script>
</body>
</html>
